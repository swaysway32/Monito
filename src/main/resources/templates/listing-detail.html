<!DOCTYPE html>
<html lang="en" data-theme="light" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${listing.name}">Listing</title>
    <link rel="stylesheet" th:href="@{/styles.css}">
    <style>
        .detail-gallery { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; }
        .detail-hero { grid-column: 1 / -1; }
        .detail-hero img, .detail-gallery img { width: 100%; height: auto; border-radius: 8px; }
        
        .rating-stars { display: flex; gap: 0.25rem; margin: 0.5rem 0; }
        .star { color: #ffd700; font-size: 1.2rem; }
        .star.empty { color: #ddd; }
        
        .review-form { background: var(--card-bg); padding: 1.5rem; border-radius: 8px; margin: 2rem 0; }
        .review-item { background: var(--card-bg); padding: 1rem; border-radius: 8px; margin: 1rem 0; border-left: 4px solid var(--accent-primary); }
        .review-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .review-rating { display: flex; gap: 0.25rem; }
        .review-date { color: var(--text-secondary); font-size: 0.9rem; }
        .review-comment { margin-top: 0.5rem; line-height: 1.5; }
        
        .rating-input { display: flex; gap: 0.5rem; margin: 1rem 0; }
        .rating-input input[type="radio"] { display: none; }
        .rating-input label { cursor: pointer; font-size: 1.5rem; color: #ddd; transition: color 0.2s; }
        .rating-input label:hover, .rating-input label:hover ~ label { color: #ffd700; }
        .rating-input input[type="radio"]:checked ~ label { color: #ffd700; }
    </style>
    </head>
<body>
<header>
    <nav class="container">
        <a th:href="@{/}" class="logo">Monito</a>
        <ul class="nav-links">
            <li><a th:href="@{/}">Home</a></li>
            <li><a href="#">Browse Pets</a></li>
            <li><a href="#">Browse Pet Toys</a></li>
            <li><a th:href="@{/become-seller}">Become a Seller</a></li>
            <li>
                <label class="theme-toggle">
                    <input type="checkbox" id="theme-switch">
                    <span class="slider"></span>
                </label>
            </li>
        </ul>
        <button class="mobile-menu-toggle">☰</button>
    </nav>
</header>

<main>
    <section class="page-header">
        <div class="container">
            <h1 class="page-title" th:text="${listing.name}">Listing</h1>
            <p class="page-subtitle" th:text="${listing.category}">Category</p>
            <p style="margin-top:0.5rem;">
                <a th:href="@{/}" style="text-decoration:none;">Home</a> /
                <a th:href="@{'/listing/' + ${listing.id}}" style="text-decoration:none;" th:text="${listing.name}">Listing</a>
            </p>
        </div>
    </section>

    <section class="main-content">
        <div class="container">
            <div class="grid grid-2">
                <div>
                    <div class="detail-gallery">
                        <div class="detail-hero" th:if="${listing.imagePaths}">
                            <img th:src="${#strings.arraySplit(listing.imagePaths, ',')[0]}" th:alt="${listing.name}">
                        </div>
                        <div th:each="img, iStat : ${#strings.arraySplit(listing.imagePaths, ',')}">
                            <img th:if="${iStat.index > 0}" th:src="${img}" th:alt="${listing.name}">
                        </div>
                    </div>
                </div>
                <div>
                    <div class="card">
                        <h2 th:text="${listing.name}">Name</h2>
                        <p class="listing-price" th:text="${'NPR ' + #numbers.formatDecimal(listing.price, 1, 'COMMA', 2, 'POINT')}">NPR 0.00</p>
                        <p><strong>Type:</strong> <span th:text="${listing.listingType}"></span></p>
                        <p><strong>Breed/Type:</strong> <span th:text="${listing.breed}"></span></p>
                        <p><strong>Age:</strong> <span th:text="${listing.age}"></span></p>
                        <p><strong>Location:</strong> <span th:text="${listing.location}"></span></p>
                        <div style="margin-top: 1rem;">
                            <h3>Description</h3>
                            <p th:text="${listing.description}"></p>
                        </div>
                        <div style="margin-top: 1rem;">
                            <h3>Contact</h3>
                            <p th:text="${listing.contact}"></p>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <a th:href="@{/}" class="btn btn-secondary">Back to Home</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Reviews Section -->
    <section class="main-content">
        <div class="container">
            <h2>Reviews & Ratings</h2>
            
            <!-- Overall Rating Summary -->
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 2rem; flex-wrap: wrap;">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; font-weight: bold; color: var(--accent-primary);" th:text="${#numbers.formatDecimal(averageRating, 1, 2)}">0.0</div>
                        <div class="rating-stars">
                            <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                  th:class="${i <= (averageRating != null ? averageRating : 0)} ? 'star' : 'star empty'">★</span>
                        </div>
                        <div style="color: var(--text-secondary);" th:text="${totalReviews} + ' review(s)'">0 reviews</div>
                    </div>
                    <div style="flex: 1;">
                        <div th:each="rating : ${#numbers.sequence(5, 1, -1)}" style="display: flex; align-items: center; gap: 1rem; margin: 0.5rem 0;">
                            <span th:text="${rating}">5</span>
                            <div style="flex: 1; height: 8px; background: #ddd; border-radius: 4px;">
                                <div style="height: 100%; background: var(--accent-primary); border-radius: 4px; width: 0%;"></div>
                            </div>
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Review Form (only for logged-in users) -->
            <div th:if="${isLoggedIn}" class="review-form">
                <h3 th:if="${userReview == null}">Write a Review</h3>
                <h3 th:if="${userReview != null}">Update Your Review</h3>
                
                <form th:action="@{'/listing/' + ${listing.id} + '/review'}" method="post">
                    <div class="rating-input">
                        <input type="radio" id="star5" name="rating" value="5" th:checked="${userReview != null && userReview.rating == 5}">
                        <label for="star5">★</label>
                        <input type="radio" id="star4" name="rating" value="4" th:checked="${userReview != null && userReview.rating == 4}">
                        <label for="star4">★</label>
                        <input type="radio" id="star3" name="rating" value="3" th:checked="${userReview != null && userReview.rating == 3}">
                        <label for="star3">★</label>
                        <input type="radio" id="star2" name="rating" value="2" th:checked="${userReview != null && userReview.rating == 2}">
                        <label for="star2">★</label>
                        <input type="radio" id="star1" name="rating" value="1" th:checked="${userReview != null && userReview.rating == 1}">
                        <label for="star1">★</label>
                    </div>
                    
                    <div style="margin: 1rem 0;">
                        <label for="comment" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Comment (optional):</label>
                        <textarea id="comment" name="comment" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; resize: vertical;" 
                                  th:placeholder="'Share your experience with this ' + ${listing.name} + '...'" 
                                  th:text="${userReview != null ? userReview.comment : ''}"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" th:text="${userReview != null ? 'Update Review' : 'Submit Review'}">Submit Review</button>
                </form>
            </div>

            <!-- Login prompt for non-logged-in users -->
            <div th:if="${!isLoggedIn}" class="card" style="text-align: center; margin: 2rem 0;">
                <h3>Want to leave a review?</h3>
                <p>Please <a th:href="@{/login}" style="color: var(--accent-primary);">log in</a> to share your experience with this product.</p>
            </div>

            <!-- Reviews List -->
            <div th:if="${reviews != null && !reviews.isEmpty()}">
                <h3>Customer Reviews</h3>
                <div th:each="review : ${reviews}" class="review-item">
                    <div class="review-header">
                        <div>
                            <strong th:text="${review.userName}">User Name</strong>
                            <div class="review-rating">
                                <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                      th:class="${i <= (review.rating != null ? review.rating : 0)} ? 'star' : 'star empty'">★</span>
                            </div>
                        </div>
                        <div class="review-date" th:text="${review.createdAt != null ? #temporals.format(review.createdAt, 'MMM dd, yyyy') : 'Recently'}">Date</div>
                    </div>
                    <div th:if="${review.comment != null && !review.comment.isEmpty()}" 
                         class="review-comment" th:text="${review.comment}">Review comment</div>
                </div>
            </div>

            <!-- No reviews message -->
            <div th:if="${reviews == null || reviews.isEmpty()}" class="card" style="text-align: center; margin: 2rem 0;">
                <h3>No reviews yet</h3>
                <p>Be the first to review this product!</p>
            </div>
        </div>
    </section>
</main>

<footer>
    <div class="container">
        <div class="footer-bottom">
            <p>&copy; 2024 Monito Pet Marketplace. All rights reserved.</p>
        </div>
    </div>
</footer>

</body>
<script>
    const themeSwitch = document.getElementById('theme-switch');
    const htmlElement = document.documentElement;
    if (themeSwitch) {
        themeSwitch.addEventListener('change', function() {
            if (this.checked) {
                htmlElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                htmlElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
        });

        const savedTheme = localStorage.getItem('theme') || 'light';
        htmlElement.setAttribute('data-theme', savedTheme);
        if (savedTheme === 'dark') {
            themeSwitch.checked = true;
        }
    }

    // Star rating interaction
    document.addEventListener('DOMContentLoaded', function() {
        const ratingInputs = document.querySelectorAll('.rating-input input[type="radio"]');
        const ratingLabels = document.querySelectorAll('.rating-input label');
        
        ratingLabels.forEach((label, index) => {
            label.addEventListener('mouseenter', function() {
                // Highlight stars on hover
                for (let i = 0; i <= index; i++) {
                    ratingLabels[i].style.color = '#ffd700';
                }
            });
        });
        
        document.querySelector('.rating-input').addEventListener('mouseleave', function() {
            // Reset to selected rating on mouse leave
            const checkedInput = document.querySelector('.rating-input input[type="radio"]:checked');
            if (checkedInput) {
                const checkedIndex = Array.from(ratingInputs).indexOf(checkedInput);
                ratingLabels.forEach((label, index) => {
                    label.style.color = index <= checkedIndex ? '#ffd700' : '#ddd';
                });
            } else {
                ratingLabels.forEach(label => {
                    label.style.color = '#ddd';
                });
            }
        });
        
        ratingInputs.forEach((input, index) => {
            input.addEventListener('change', function() {
                // Update star colors when rating is selected
                ratingLabels.forEach((label, i) => {
                    label.style.color = i <= index ? '#ffd700' : '#ddd';
                });
            });
        });
    });
</script>
</html>


